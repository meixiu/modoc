[TOCM]

[TOC]

## 概要
GtaCMS系统的模板标签功能是基于Twig模板引擎开发的，本文档将介绍Twig模板引擎的基本语法，掌握好本文档介绍的内容已经足够用于我们CMS模板的开发，如果需要更深入的了解，可以查阅： [Twig中文文档](https://www.kancloud.cn/yunye/twig-cn/159454 "Twig中文文档")

模板实际上就是一个带有各种转义标签的文本文件，常用的是`.html`的文件。
我们支持`.html`和`.twig`两种文件格式做为模板文件。
- `.html`更熟悉，更容易理解
- `.twig`是Twig标准的模板文件名，用它的好处是在IDE下可以获得很好的代码提示和高亮（比如webstorm & phpstorm里）

下面是一个基本的模板示例
```html
<!DOCTYPE html>
<html>
    <head>
        <title>{{webTitle}}</title>
    </head>
    <body>
		{% set navigation = get_navigation()%}
        <ul id="navigation">
        {% for item in navigation %}
            <li><a href="{{ item.href }}">{{ item.caption }}</a></li>
        {% endfor %}
        </ul>
        <h1>My Webpage</h1>
        {{ a_variable }}
    </body>
</html>
```

如果你看懂了，那么恭喜你，你应该是一个天才！

## 定位符
Twig有两种定位符 `{{ ...  }}` 和 `{% ... %}`，定位符是可以配置的，但是我们保留默认的配置，因为采用默认配置可以获得IDE的代码提示和自动完成功能。

- `{{ ... }}` 输出定位符：在当前位置输出 `...`的结果
- `{% ... %}` 执行定位符：在当前位置执行`...` 内的语句，可执行语句我们称之为标签，标签是定义好的，详细见后面`标签列表`

## 变量
变量就是后端提供的数据，可以是字符串，数组，对象。变量通常是用来输出或者循环。
```
// 输出一个字符串变量
{{ webTitle }}

// 输出data数组的name属性值
{{ data.name }}

// 输出data数组的name属性值
{{ data['name'] }}

// 循环一个数组
{% for item in itemArr %}
		...
{% endfor %}
```
也可以在模板中自定义变量：
```
{% set foo = 'foo' %}
{% set foo = [1, 2] %}
{% set foo = {'foo': 'bar'} %}
```
注意：输出用`{{ }}`，执行标签用`{% %}`


##函数

函数可被调用，用于生产内容。函数通过函数名被调用，其后紧跟圆括号`()`，它还可以设置参数。

举个例子，range返回一个包含整数等差数列的列表：
```
{% for i in range(0, 3) %}
    {{ i }},
{% endfor %}
```
输出get_article_title函数的返回结果:
```
{{ get_article_title() }}
```

可以使用具名参数，这样就可以不用记住函数参数的位置，而且也更直观：
```
{% for i in range(low=1, high=10, step=2) %}
    {{ i }},
{% endfor %}
```
具名参数允许跳过某些不需要改变默认值的参数：
```
{# 第一个参数是日期格式，如果传递的是空值，它将是默认的全局日期格式。 #}
{{ "now"|date(null, "Europe/Paris") }}

{# 或者，通过为时区使用一个具名实参来跳过格式值。#}
{{ "now"|date(timezone="Europe/Paris") }}
```

##过滤器
过滤器和函数功能很类似，过滤器filters通常是用来修改变量，相比函数语法更加简洁，书写起来更加方便。

过滤器的基本语法，用`|`连接变量和过滤器名：
```
{{ 变量名 | filters1 | filters2 }}
```

下面的例子会先删除变量name所包含的文本的所有html标签，再输出:
```
{{ name|striptags }}
```
过滤器接收由圆括号包裹的参数。这个例子中，加入了一个由逗号分隔的参数列表：
```
{{ list|join(', ') }}
```
同时使用多个过滤器，去除所有的html标签，并且将英文转成大写
```
{{ name|striptags|upper }}
```


##控制结构
控制结构是指控制程序流程的条件语句（例如 if/elseif/else），for循环等。控制结构出现在 {% ... %}块中。

例如，要显示一个被调用的user变量中提供的用户（users）列表，使用for标签：
```
<h1>Members</h1>
<ul>
    {% for user in users %}
        <li>{{ user.username|e }}</li>
    {% endfor %}
</ul>
```
if 标签可以用来测试表达式：
```
{% if users|length > 0 %}
    <ul>
        {% for user in users %}
            <li>{{ user.username|e }}</li>
        {% endfor %}
    </ul>
{% endif %}
```
##注释
要在模板中注释某一行，使用注释语法{# ...#}，注释不会出现在html源文件里。
```
{# note: disabled template because we no longer use this
    {% for user in users %}
        ...
    {% endfor %}
#}
```

##转义
当由模板生成HTML时，包含字符的变量如果包含有HTML字符可能会影响最终生成的页面，所有模板引擎对于变量里的html文本默认是开启转义的。

有的时候我们需要直接使用变量里的html字符，可以使用`raw`过滤器：
```
{{ htmlOutput|raw }}
```
想要在模板中以原生字符串的形式使用{{，而不是以变量的开头定界符来使用:
```
{{ '{{' }}
```

##表达式

允许在任意位置使用表达式。表达式非常类似常规的 PHP代码或者JS代码，总之你很熟悉。

###字面值（Literals）

表达式的最简单形式就是字面值。字面值是对PHP类型的陈述，比如字符串、数字、以及数组。以下字面值都是存在的

- `"Hello World"`：字符串用双引号表示
- `["foo", "bar"]`：数组，类似JSON
- `{"foo": "bar"}`： 关联数组，类似JSON
- `{ 2: 'foo', 4: 'bar' }`：数字键值数组，类似JSON
- `true / false`: true 表示正确的值，false表示错误的值
- `null`: null 表示没有具体的值

是不是很熟？数组还可以嵌套，这和JSON也很像：
```
{% set foo = [1, {"foo": "bar"}] %}
```
思考一下：上面的表达式代表什么意思？

###比较运算符

以下比较运算符可以用于任意表达式中：
```
==, !=, <, >, >=, 和 <=。
```

你还可以检查字符串是否由另一个字符串开头starts with或结尾ends with：
```
{% if 'Fabien' starts with 'F' %}
{% endif %}

{% if 'Fabien' ends with 'n' %}
{% endif %}
```
###逻辑运算符

你可以使用以下操作符来组合多个表达式：

`and`: 与。如果左操作数和右操作数都为真，则返回true

`or`: 或。如果左操作数或右操作数为真，则返回true。

`not`: 非。如果右侧操作数为假，则返回true。

###包含操作符

包含操作符 in 用于测试是否存在包含关系。

如果左侧运算对象包含在右侧运算对象中，则返回 true：
```
{# returns true #}
{{ 1 in [1, 2, 3] }}

{{ 'cd' in 'abcde' }}
```
使用not in操作符执行否测试：
```
{% if 1 not in [1, 2, 3] %}

{# 全等于 #}
{% if not (1 in [1, 2, 3]) %}
```

###测试操作符（Test Operator）

使用is操作符执行测试。测试可以用于针对变量和一般表达式之间的关系进行测试。右侧操作数即是测试的名称：
```
{# 检查变量是否是奇数 #}

{{ name is odd }}

{{ name is not odd}}
```
测试可以接受参数：
```
{% if post.status is constant('Post::PUBLISHED') %}
```
###其他操作符
以下操作符不适用于其他类型中：

`|`: 使用一个过滤器。
`~`: 将所有操作数转换为字符串并连接它们。`{{ "Hello " ~ name ~ "!" }}` 将会返回（当name == 'John'）` Hello John!`。

`.`,` []`: 获取对象的属性。

`?::`：三元操作符：
```
{{ foo ? 'yes' : 'no' }}
```
`??`: 非空操作符：
```
{# 如果foo已被定义非空值，则返回foo的值，否则返回'no' #}
{{ foo ?? 'no' }}
```

##引入其他模板
使用 `include` 标签或者函数使你更方便地在模板中引入模板，并将该模板已渲染后的内容返回到当前模板：
```
{{ include('sidebar.html') }}
```
可以使用斜线来访问子目录内获者其它目录内的模板：
```
{{ include('articles/sidebar.html') }}
```

##模板继承(布局)
使用模板继承可以实现类似布局的功能，通常我们定义一个网站的主体框架模板，模板里面分区块由其它的模板来渲染，以此来解构整个模板结构。

现在，我们来定义一个基础的模板，`base.html`：
```
<!DOCTYPE html>
<html>
    <head>
            <link rel="stylesheet" href="style.css" />
            <title>My Webpage</title>
    </head>
    <body>
        <div id="content">
			{% block content %}
				这里的内容由子页面的内容进行替换
			{% endblock %}
		</div>
        <div id="footer">
            {% block footer %}
                &copy; Copyright 2011 by <a href="http://domain.invalid/">you</a>
            {% endblock %}
        </div>
    </body>
</html>
```
以上的布局模板里定义了`content` 和 `footer` 两个区块，这两块的内容将有继承它的子模板的`block`的标签内容来覆写：
```
{% extends "base.html" %}
{% block content %}
    <h1>Index</h1>
    <p class="important">
		这里的内容将最终显示
        Welcome to my awesome homepage.
    </p>
{% endblock %}
```
其中的 `extends` 标签是关键所在。它告诉模板引擎当前模板扩展自另一个模板。当模板系统评估这个模板时，首先会定位到父模板。

注意：`extends` 标签必须是模板的第一个标签。
注意：由于子模版未定义`footer`块，就用来自父模板的值替代使用了。

可以通过使用`parents`函数来渲染父级块。它将返回父级块的结果：
```
{% block sidebar %}
    <h3>Table Of Contents</h3>
    ...
    {{ parent() }}
{% endblock %}
```


## 编码规范

在编写模版时，我们推荐使用以下这些编码规范：

在起始定界符(`{{`, `{%`,and `{#`)的后面加一个空格，并在结尾定界符(`}}`, `%}`, and `#}`)前面加一个空格：
```
{{ foo }}
{# comment #}
{% if foo %}{% endif %}
```

在以下操作符前后添加一个空格：比较运算符 (`==, !=, <, >, >=, <=`), 数学运算符 (`+, -, /, *, %, //, **`), 逻辑运算符 (`not, and, or`), `~, is, in`, 以及三元运算符(`?:`):

```
{{ 1 + 2 }}
{{ foo ~ bar }}
{{ true ? true : false }}
```
在键值数组中的`:`后添加一个空格，散列和数组的,后也添加一个空格：
```
{{ [1, 2, 3] }}
{{ {'foo': 'bar'} }}
```
不要在表达式的圆括号前后添加空格：
```
{{ 1 + (2 * 3) }}
```
不要在字符串分隔符前后添加空格：
```
    {{ 'foo' }}
    {{ "foo" }}
```
不要在以下操作符前后添加空格： `|, ., .., []`:
```
    {{ foo|upper|lower }}
    {{ user.name }}
    {{ user[name] }}
    {% for i in 1..12 %}{% endfor %}
```
不要在过滤器和函数调用中的圆括号前后添加空格：
```
     {{ foo|default('foo') }}
     {{ range(1..10) }}
```
不要在数组的首尾添加空格：
```
     {{ [1, 2, 3] }}
     {{ {'foo': 'bar'} }}
```
变量名必须包含小写字母和下划线或者驼峰：
```
     {% set foo = 'foo' %}
     {% set foo_bar = 'foo' %}
```
在标签内缩进代码（使用与模板渲染的目标语言相同的缩进方式）
```
     {% block foo %}
        {% if true %}
            true
        {% endif %}
     {% endblock %}
```











